<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> MoE-Pruner | Shirin Tahmasebi </title> <meta name="author" content="Shirin Tahmasebi"> <meta name="description" content="Pruning MoE LLMs "> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?ce48ee9bc248ee6b18f3aeefc03ed2f9"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://shirintahmasebi.github.io/compression/2024/moe_pruner/"> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Shirin Tahmasebi </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">CV </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/publications/">Publications</a> <a class="dropdown-item " href="/background/">Background</a> </div> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Notes </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/bias/">Bias</a> <a class="dropdown-item " href="/tokenization/">Tokenization</a> <a class="dropdown-item " href="/llm_judge/">LLM as Evaluator</a> <a class="dropdown-item " href="/prompt/">Prompt Engineering</a> <a class="dropdown-item " href="/compression/">LLM Compression</a> <a class="dropdown-item " href="/agents/">LLM Agents</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/recsys/">Recommendation Systems</a> <a class="dropdown-item " href="/other/">Others</a> </div> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">MoE-Pruner</h1> <p class="post-meta"> October 15, 2024 </p> <p class="post-tags"> <i class="fa-solid fa-calendar fa-sm"></i> 2024   ·   <i class="fa-solid fa-hashtag fa-sm"></i> compression   <i class="fa-solid fa-hashtag fa-sm"></i> pruning   </p> </header> <article class="post-content"> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h2"> <a href="#moe-pruner-pruning-moe-llms-using-the-hints-from-its-router">MoE-Pruner: Pruning MoE LLMs using the Hints from Its Router</a> <ul> <li class="toc-entry toc-h3"><a href="#introduction">Introduction</a></li> <li class="toc-entry toc-h3"> <a href="#backgroud-and-research-gap">Backgroud and Research Gap</a> <ul> <li class="toc-entry toc-h4"><a href="#mixtral-a-high-performance-moe-model">Mixtral: A High-Performance MoE Model</a></li> <li class="toc-entry toc-h4"><a href="#moe-disadvantage">MoE Disadvantage</a></li> <li class="toc-entry toc-h4"><a href="#research-gap">Research Gap</a></li> </ul> </li> <li class="toc-entry toc-h3"><a href="#solution-moe-pruner">Solution: MoE-Pruner</a></li> <li class="toc-entry toc-h3"><a href="#conclusion">Conclusion</a></li> </ul> </li> </ul> </div> <hr> <div id="markdown-content"> <h2 id="moe-pruner-pruning-moe-llms-using-the-hints-from-its-router"><a href="https://arxiv.org/pdf/2410.12013" rel="external nofollow noopener" target="_blank">MoE-Pruner: Pruning MoE LLMs using the Hints from Its Router</a></h2> <h3 id="introduction">Introduction</h3> <p>As the size of LLMs continues to expand, their computational and memory requirements have become increasingly prohibitive for both training and inference. Mixture-of-Experts (MoE) architectures offer a promising solution by introducing sparse activation, where only a subset of model parameters is utilized at any given time. However, while MoE significantly reduces inference costs compared to fully dense models, it also introduces new challenges such as expert redundancy, inefficient parameter utilization, and increased memory demands. Pruning techniques have been widely used to compress dense transformers, but standard pruning approaches fail to leverage the unique structure of MoE models, where a router dynamically assigns tokens to different experts. To address this, MoE-Pruner introduces a router-aware pruning strategy that incorporates routing weights into the pruning metric, ensuring that important experts remain intact while redundant ones are eliminated. Additionally, an expert-wise knowledge distillation method is employed to recover lost performance post-pruning, making this technique both effective and computationally efficient.</p> <p>This pruning method can be categorized based on:</p> <ol> <li> <strong>Granularity</strong>: Unstructured pruning at the weight level inside experts. It is worth mentioning that while it is not strictly a structured pruning method (e.g., removing entire neurons, layers, or experts), its router-aware mechanism makes it aware of expert importance, making it different from fully unstructured pruning methods like SparseGPT or Wanda.</li> <li> <strong>Pruning Criteria</strong>: Uses a router-informed metric that combines weight magnitude, input activation norms, and router probabilities to prioritize pruning decisions.</li> <li> <strong>Pruning Ratio</strong>: Supports high sparsity levels (e.g., 50%) while preserving most of the model’s original performance.</li> <li> <strong>Need for Retraining</strong>: One-shot pruning that does not require retraining, but performance can be enhanced via expert-wise knowledge distillation.</li> </ol> <h3 id="backgroud-and-research-gap">Backgroud and Research Gap</h3> <p>As LLMs continue to grow in size, their computational and memory requirements have become a major bottleneck for both training and inference. To address these challenges, Mixture-of-Experts (MoE) architectures have emerged as an efficient alternative to fully dense transformer models. Instead of activating all parameters for every input, MoE selectively routes different tokens to different experts, significantly reducing computation while maintaining model expressiveness.</p> <p>At its core, an MoE model consists of three key components: a router (gating network), a set of experts (feedforward networks), and a sparse activation mechanism. Each token in an input sequence is first processed by the router, which assigns a probability distribution over all available experts. Instead of utilizing all experts for every token, the router typically selects the top-K experts (often Top-2) with the highest probability scores. These selected experts then process the token, and their outputs are weighted and aggregated based on the router’s assignment.</p> <p>This token-level routing mechanism allows MoE models to scale efficiently while keeping computational costs manageable. Unlike traditional transformers, where every token flows through the same fully connected layers, MoE models enable specialization by allowing different experts to learn distinct representations. For instance, some experts may specialize in syntactic structures, while others focus on semantic relationships or domain-specific knowledge. This targeted processing contributes to improved model efficiency and better generalization across diverse tasks.</p> <h4 id="mixtral-a-high-performance-moe-model">Mixtral: A High-Performance MoE Model</h4> <p>One of the most notable recent MoE architectures is Mixtral, an open-source model developed as a successor to LLaMA. Mixtral-8x7B, for example, consists of eight experts, but only two experts are active per token. This means that while the full model has 47 billion parameters, only 12.5 billion are used at a time, making inference significantly more efficient than a dense model of the same size.</p> <p>In Mixtral, the router is responsible for selecting which two experts will process each token. The router assigns probability scores to each expert using a learned gating function, ensuring that different tokens are routed to the most relevant experts. Each expert in Mixtral is essentially a feedforward network (FFN), similar to those found in dense transformers but trained to specialize in different types of linguistic patterns. This enables Mixtral to achieve strong generalization and efficiency, making it one of the leading MoE models available.</p> <h4 id="moe-disadvantage">MoE Disadvantage</h4> <p>Despite its advantages, MoE presents unique challenges. The presence of redundant or underutilized experts can lead to wasted computational resources, and imbalanced expert utilization—known as representation collapse—can reduce model effectiveness. Furthermore, MoE architectures require increased memory bandwidth due to the need for maintaining multiple experts. To mitigate these issues, various strategies such as expert pruning, expert merging, and knowledge distillation have been explored to optimize MoE models while preserving their performance.</p> <h4 id="research-gap">Research Gap</h4> <p>While MoE models like Mixtral offer computational efficiency by selectively activating only a subset of experts, they introduce new challenges related to expert redundancy and underutilization. Many MoE models suffer from representation collapse, where certain experts dominate while others remain underused, leading to inefficiencies in parameter utilization. Traditional pruning methods like SparseGPT and Wanda fail to address this issue because they treat all weights equally, without considering how frequently experts are used.</p> <p>To bridge this gap, MoE-Pruner introduces a router-aware pruning strategy that leverages router weights to inform pruning decisions. By incorporating routing probabilities into the pruning metric, MoE-Pruner ensures that frequently used experts are preserved while less critical ones are pruned, making it more effective than traditional weight-based pruning techniques. Furthermore, expert-wise knowledge distillation helps recover model performance post-pruning, making this method particularly well-suited for optimizing MoE-based LLMs.</p> <h3 id="solution-moe-pruner">Solution: MoE-Pruner</h3> <p>MoE-Pruner is an <strong>extension of Wanda</strong>, specifically designed for <strong>pruning MoE models</strong> by incorporating <strong>router weights</strong> into the pruning process. While Wanda prunes weights based on <strong>magnitude and input activations</strong>, MoE-Pruner enhances this approach by <strong>leveraging the routing probabilities</strong>, ensuring that frequently used experts are preserved while less utilized ones are pruned more aggressively.</p> <p>The pruning process starts by analyzing the <strong>MoE routing mechanism</strong>, where each input token is assigned to a subset of experts based on learned gating probabilities. These router weights indicate how often each expert is utilized, providing a <strong>critical signal</strong> for pruning decisions. Instead of treating all weights equally, MoE-Pruner extends Wanda’s pruning metric by introducing a <strong>router-aware importance score</strong>:</p> \[S = \vert W_{ij} \vert \times \|X_j \times G_j\|\] <p>where:</p> <ul> <li>\(W_{ij}\) is the weight magnitude,</li> <li>\(X_j\) is the input activation norm,</li> <li>\(G_j\) is the router weight assigned to the expert.</li> </ul> <p>This adjustment ensures that weights within highly utilized experts are pruned more conservatively, while those in <strong>rarely activated experts</strong> are <strong>pruned more aggressively</strong>.</p> <p>Pruning is applied <strong>at the weight level within each expert</strong>, making it an <strong>unstructured pruning method</strong>. Unlike structured expert pruning approaches that remove entire experts, MoE-Pruner preserves all experts but naturally reduces capacity in underutilized ones by pruning more of their parameters.</p> <p>Since pruning can introduce some performance degradation, MoE-Pruner includes an <strong>expert-wise knowledge distillation</strong> step. After pruning, the compressed model is fine-tuned using the original pretrained MoE model as a <strong>teacher</strong>, transferring knowledge back to the pruned model. This enables the pruned model to retain nearly all of its original performance, despite having significantly fewer active weights.</p> <p>In summary, MoE-Pruner is a <strong>router-aware extension of Wanda</strong>, designed to optimize MoE models by pruning weights intelligently based on both input activations and expert utilization. By integrating routing information into the pruning process, it achieves better compression with minimal performance loss, outperforming traditional LLM pruning techniques that do not account for expert specialization.</p> <h3 id="conclusion">Conclusion</h3> <p>MoE-Pruner extends Wanda by introducing a router-aware pruning strategy, making it better suited for MoE models. By incorporating routing probabilities into the pruning metric, it ensures that frequently used experts retain more parameters, while underutilized experts are pruned more aggressively. This unstructured, one-shot pruning method reduces computational overhead while maintaining strong model performance. Additionally, expert-wise knowledge distillation helps recover any accuracy loss post-pruning. As MoE models become more prevalent, MoE-Pruner provides an effective approach for optimizing their efficiency without sacrificing their expressiveness.</p> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Shirin Tahmasebi. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?4a129fbf39254905f505c7246e641eaf"></script> <script defer src="/assets/js/copy_code.js?7254ae07fe9cc5f3a10843e1c0817c9c" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>